name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install CLI MCP Mapper
      - name: Install CLI MCP Mapper
        run: npm install -g cli-mcp-mapper

      # Clone and build SharpToolsMCP
      - name: Clone SharpToolsMCP
        run: |
          git clone https://github.com/kooshi/SharpToolsMCP.git /tmp/SharpToolsMCP

      - name: Build SharpToolsMCP Stdio Server
        run: |
          cd /tmp/SharpToolsMCP
          dotnet publish SharpTools.StdioServer/SharpTools.StdioServer.csproj \
            --configuration Release \
            --runtime linux-x64 \
            --self-contained true \
            --output /tmp/sharptools-build

      - name: Install SharpToolsMCP to system
        run: |
          sudo mkdir -p /usr/lib/sharptools
          sudo cp -r /tmp/sharptools-build/* /usr/lib/sharptools/
          sudo chmod +x /usr/lib/sharptools/SharpTools.StdioServer
          sudo ln -sf /usr/lib/sharptools/SharpTools.StdioServer /usr/bin/sharptools

      - name: Create SharpTools log directory
        run: mkdir -p $HOME/.local/var/log/sharptools

      # Copy CLI commands configuration to expected location
      - name: Setup CLI MCP Mapper configuration
        run: |
          mkdir -p $HOME/.config/cli-mcp-mapper
          cp .github/commands.json $HOME/.config/cli-mcp-mapper/commands.json
          echo "CLI MCP Mapper configuration:"
          cat $HOME/.config/cli-mcp-mapper/commands.json

      # Verify installations
      - name: Verify installations
        run: |
          echo "=== SharpTools ==="
          which sharptools
          echo ""
          echo "=== SharpTools BuildHost Check ==="
          if [ ! -d /usr/lib/sharptools/BuildHost-netcore ]; then
            echo "ERROR: BuildHost-netcore directory not found!"
            exit 1
          fi
          echo ""
          echo "=== cli-mcp-mapper ==="
          cli-mcp-mapper --dry-run
          echo ""
          echo "=== .NET SDK ==="
          dotnet --version
