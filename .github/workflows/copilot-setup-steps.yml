name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install cclsp
      - name: Install cclsp
        run: npm install -g cclsp@latest

      # Install CLI MCP Mapper
      - name: Install CLI MCP Mapper
        run: npm install -g git+https://github.com/SteffenBlake/cli-mcp-mapper.git

      # Download and setup Roslyn LSP for C#
      # To update to newer version, get the url from here: https://dev.azure.com/azure-public/vside/_artifacts/feed/vs-impl/NuGet/Microsoft.CodeAnalysis.LanguageServer.linux-x64

      # Download and setup Roslyn LSP for C#
      - name: Set up .NET SDK
        uses: actions/setup-dotnet@v5
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'preview'

      - name: Check dotnet version
        run: dotnet --version
      
      - name: Download Roslyn Language Server
        run: |
          # Download the package using the new dotnet package download command
          dotnet package download Microsoft.CodeAnalysis.LanguageServer.linux-x64 \
            --source https://pkgs.dev.azure.com/azure-public/vside/_packaging/vs-impl/nuget/v3/index.json \
            --output ./roslyn-packages \
            --prerelease

      - name: Extract and setup Roslyn LSP
        run: |
          # Find the downloaded .nupkg file
          NUPKG_FILE=$(find ./roslyn-packages -name "Microsoft.CodeAnalysis.LanguageServer.linux-x64*.nupkg" | head -1)
          echo "Found package: $NUPKG_FILE"
          
          # Extract it (nupkg is a zip file)
          unzip -q "$NUPKG_FILE" -d roslyn-temp
          
          # Move to target location
          mkdir -p $HOME/.local/lib
          cp -r roslyn-temp/content/LanguageServer/linux-x64 $HOME/.local/lib/Microsoft.CodeAnalysis.LanguageServer
          
          # Make executable
          chmod +x $HOME/.local/lib/Microsoft.CodeAnalysis.LanguageServer/Microsoft.CodeAnalysis.LanguageServer
          
          # Symlink to PATH
          sudo ln -s $HOME/.local/lib/Microsoft.CodeAnalysis.LanguageServer/Microsoft.CodeAnalysis.LanguageServer /usr/local/bin/Microsoft.CodeAnalysis.LanguageServer
          
          # Clean up
          rm -rf ./roslyn-packages roslyn-temp

      - name: Verify Roslyn LSP installation
        run: |
          which Microsoft.CodeAnalysis.LanguageServer
          ls -la $HOME/.local/lib/Microsoft.CodeAnalysis.LanguageServer/

      # Create log directory for Roslyn LSP
      - name: Create Roslyn LSP log directory
        run: mkdir -p $HOME/.local/var/log/roslyn-lsp

      # Create the cclsp configuration file
      - name: Create cclsp configuration
        run: |
          mkdir -p $HOME/.config/claude
          cat > $HOME/.config/claude/cclsp.json << 'EOF'
          {
            "servers": [
              {
                "extensions": ["cs", "csx"],
                "command": [
                  "Microsoft.CodeAnalysis.LanguageServer",
                  "--stdio",
                  "--logLevel",
                  "Information",
                  "--extensionLogDirectory",
                  "$HOME/.local/var/log/roslyn-lsp"
                ],
                "rootDir": "."
              }
            ]
          }
          EOF

      # Copy CLI commands configuration to expected location
      - name: Setup CLI MCP Mapper configuration
        run: |
          mkdir -p $HOME/.config/cli-mcp-mapper
          cp .github/commands.json $HOME/.config/cli-mcp-mapper/commands.json
          echo "CLI MCP Mapper configuration:"
          cat $HOME/.config/cli-mcp-mapper/commands.json

      # Verify installations
      - name: Verify installations
        run: |
          echo "=== cclsp ==="
          which cclsp
          cat $HOME/.config/claude/cclsp.json
          echo ""
          echo "=== cli-mcp-mapper ==="
          which cli-mcp-mapper
          cat $HOME/.config/cli-mcp-mapper/commands.json
          echo "=== Roslyn ==="
          Microsoft.CodeAnalysis.LanguageServer --version

      # Verify cclsp is ready
      - name: Verify cclsp installation
        run: |
          which cclsp
          cat $HOME/.config/claude/cclsp.json
