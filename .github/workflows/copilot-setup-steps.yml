name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '8.0.x'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install cclsp
      - name: Install cclsp
        run: npm install -g cclsp@latest

      # Install CLI MCP Mapper
      - name: Install CLI MCP Mapper
        run: npm install -g cli-mcp-mapper

      # Download and setup Roslyn LSP for C#
      - name: Download Roslyn Language Server
        run: |
          dotnet tool install --global roslyn-language-server --prerelease

      # Create log directory for Roslyn LSP
      - name: Create Roslyn LSP log directory
        run: mkdir -p $HOME/.local/var/log/roslyn-lsp

      # Create the cclsp configuration file
      - name: Create cclsp configuration
        run: |
          mkdir -p $HOME/.config/claude
          cat > $HOME/.config/claude/cclsp.json << 'EOF'
          {
            "servers": [
              {
                "extensions": ["cs", "csx"],
                "command": [
                  "roslyn-language-server",
                  "--stdio",
                  "--logLevel",
                  "Information",
                  "--extensionLogDirectory",
                  "$HOME/.local/var/log/roslyn-lsp"
                ],
                "rootDir": "."
              }
            ]
          }
          EOF

      # Clone and build SharpToolsMCP
      - name: Clone SharpToolsMCP
        run: |
          git clone https://github.com/kooshi/SharpToolsMCP.git /tmp/SharpToolsMCP

      - name: Build SharpToolsMCP Stdio Server
        run: |
          cd /tmp/SharpToolsMCP
          dotnet publish SharpTools.StdioServer/SharpTools.StdioServer.csproj \
            --configuration Release \
            --runtime linux-x64 \
            --self-contained true \
            --output /tmp/sharptools-build

      - name: Install SharpToolsMCP to system
        run: |
          sudo mkdir -p /usr/lib/sharptools
          sudo cp -r /tmp/sharptools-build/* /usr/lib/sharptools/
          sudo chmod +x /usr/lib/sharptools/SharpTools.StdioServer
          sudo ln -sf /usr/lib/sharptools/SharpTools.StdioServer /usr/bin/sharptools

      - name: Create SharpTools log directory
        run: mkdir -p $HOME/.local/var/log/sharptools

      # Copy CLI commands configuration to expected location
      - name: Setup CLI MCP Mapper configuration
        run: |
          mkdir -p $HOME/.config/cli-mcp-mapper
          cp .github/commands.json $HOME/.config/cli-mcp-mapper/commands.json
          echo "CLI MCP Mapper configuration:"
          cat $HOME/.config/cli-mcp-mapper/commands.json

      # Verify installations
      - name: Verify installations
        run: |
          echo "=== cclsp ==="
          which cclsp
          cat $HOME/.config/claude/cclsp.json
          echo ""
          echo "=== Roslyn ==="
          roslyn-language-server --version
          echo ""
          echo "=== SharpTools ==="
          which sharptools
          ls -lah /usr/lib/sharptools/
          echo ""
          echo "=== BuildHost Check ==="
          if [ ! -d /usr/lib/sharptools/BuildHost-netcore ]; then
            echo "ERROR: BuildHost-netcore directory not found!"
            exit 1
          fi
          ls -lah /usr/lib/sharptools/BuildHost-netcore/
          echo ""
          echo "=== cli-mcp-mapper ==="
          cli-mcp-mapper --dry-run
          echo ""
          echo "=== .NET SDK ==="
          dotnet --version
