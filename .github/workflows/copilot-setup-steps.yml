name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install cclsp
      - name: Install cclsp
        run: npm install -g cclsp@latest

      # Download and setup Roslyn LSP for C#
      # To update to newer version, get the url from here: https://dev.azure.com/azure-public/vside/_artifacts/feed/vs-impl/NuGet/Microsoft.CodeAnalysis.LanguageServer.linux-x64
      - name: Download Roslyn Language Server
        run: |
          curl -L -o roslyn-lsp.zip "https://pkwvsblobprodwus2126.vsblob.vsassets.io/b-63b6279ad2f14bc3a21cdb7614e92831/AF71924619F7BFF46A18415BC4B9D5A5ACD0930AF8793BB3EB9AC3904FB5A32100.blob?sv=2019-07-07&sr=b&sig=8euPRp5LF54HcUXYiW2YCUsAIjTGua4AmPXMkCMN03k%3D&skoid=8f4a31b6-ccf8-4d83-8ff6-444a0146cdb6&sktid=33e01921-4d64-4f8c-a055-5bdaffd5e33d&skt=2026-02-03T19%3A10%3A58Z&ske=2026-02-05T20%3A10%3A58Z&sks=b&skv=2019-07-07&se=2026-02-03T23%3A44%3A14Z&sp=r&rscl=x-e2eid-92396888-13cf47a5-8cd5fc83-35e882d9-session-92396888-13cf47a5-8cd5fc83-35e882d9&rscd=attachment%3B%20filename%3D%22Microsoft.CodeAnalysis.LanguageServer.linux-x64.5.4.0-2.26080.13.nupkg%22&P1=1770173054&P2=2&P3=2&P4=6rKzXzsK6%2bWRwKArZ54ur%2bCg9PqI4%2brV%2fADbHTxkWtg%3d"

      - name: Extract and setup Roslyn LSP
        run: |
          # Create target directory
          mkdir -p $HOME/.local/lib
          
          # Unzip the package
          unzip roslyn-lsp.zip -d roslyn-temp
          
          # Move the language server to a permanent location
          mv roslyn-temp/content/LanguageServer/linux-x64 $HOME/.local/lib/Microsoft.CodeAnalysis.LanguageServer
          
          # Make the executable... executable
          chmod +x $HOME/.local/lib/Microsoft.CodeAnalysis.LanguageServer/Microsoft.CodeAnalysis.LanguageServer
          
          # Symlink to PATH
          sudo ln -s $HOME/.local/lib/Microsoft.CodeAnalysis.LanguageServer/Microsoft.CodeAnalysis.LanguageServer /usr/local/bin/Microsoft.CodeAnalysis.LanguageServer
          
          # Clean up temp files
          rm -rf roslyn-temp roslyn-lsp.zip

      - name: Verify Roslyn LSP installation
        run: |
          which Microsoft.CodeAnalysis.LanguageServer
          ls -la $HOME/.local/lib/Microsoft.CodeAnalysis.LanguageServer/

      # Create log directory for Roslyn LSP
      - name: Create Roslyn LSP log directory
        run: mkdir -p $HOME/.local/var/log/roslyn-lsp

      # Create the cclsp configuration file
      - name: Create cclsp configuration
        run: |
          mkdir -p $HOME/.config/claude
          cat > $HOME/.config/claude/cclsp.json << 'EOF'
          {
            "servers": [
              {
                "extensions": ["cs", "csx"],
                "command": [
                  "Microsoft.CodeAnalysis.LanguageServer",
                  "--stdio",
                  "--logLevel",
                  "Information",
                  "--extensionLogDirectory",
                  "$HOME/.local/var/log/roslyn-lsp"
                ],
                "rootDir": "."
              }
            ]
          }
          EOF

      # Verify cclsp is ready
      - name: Verify cclsp installation
        run: |
          which cclsp
          cat $HOME/.config/claude/cclsp.json
