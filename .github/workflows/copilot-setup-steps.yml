name: "Copilot Setup Steps"

on:
  workflow_dispatch:
  push:
    paths:
      - .github/workflows/copilot-setup-steps.yml
  pull_request:
    paths:
      - .github/workflows/copilot-setup-steps.yml

jobs:
  copilot-setup-steps:
    runs-on: ubuntu-latest

    permissions:
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      # Install cclsp
      - name: Install cclsp
        run: npm install -g cclsp@latest

      # Install CLI MCP Mapper
      - name: Install CLI MCP Mapper
        run: npm install -g cli-mcp-mapper

      # Download and setup Roslyn LSP for C#
      # To update to newer version, get the url from here: https://dev.azure.com/azure-public/vside/_artifacts/feed/vs-impl/NuGet/Microsoft.CodeAnalysis.LanguageServer.linux-x64

      # Download and setup Roslyn LSP for C#
      - name: Download Roslyn Language Server
        run: |
          dotnet tool install --global roslyn-language-server --prerelease

      # Create log directory for Roslyn LSP
      - name: Create Roslyn LSP log directory
        run: mkdir -p $HOME/.local/var/log/roslyn-lsp

      # Create the cclsp configuration file
      - name: Create cclsp configuration
        run: |
          mkdir -p $HOME/.config/claude
          cat > $HOME/.config/claude/cclsp.json << 'EOF'
          {
            "servers": [
              {
                "extensions": ["cs", "csx"],
                "command": [
                  "roslyn-language-server",
                  "--stdio",
                  "--logLevel",
                  "Information",
                  "--extensionLogDirectory",
                  "$HOME/.local/var/log/roslyn-lsp"
                ],
                "rootDir": "."
              }
            ]
          }
          EOF

      # Copy CLI commands configuration to expected location
      - name: Setup CLI MCP Mapper configuration
        run: |
          mkdir -p $HOME/.config/cli-mcp-mapper
          cp .github/commands.json $HOME/.config/cli-mcp-mapper/commands.json
          echo "CLI MCP Mapper configuration:"
          cat $HOME/.config/cli-mcp-mapper/commands.json

      # Verify installations
      - name: Verify installations
        run: |
          echo "=== cclsp ==="
          which cclsp
          cat $HOME/.config/claude/cclsp.json
          echo ""
          echo "=== cli-mcp-mapper ==="
          which cli-mcp-mapper
          cat $HOME/.config/cli-mcp-mapper/commands.json
          echo "=== Roslyn ==="
          roslyn-language-server --version 

      # Verify cclsp is ready
      - name: Verify cclsp installation
        run: |
          which cclsp
          cat $HOME/.config/claude/cclsp.json
